<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tools - Martin Tile Server Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="10-installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="20-run.html"><strong aria-hidden="true">2.</strong> Running</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="21-run-with-cli.html"><strong aria-hidden="true">2.1.</strong> Command Line Interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="21-env-vars.html"><strong aria-hidden="true">2.1.1.</strong> Environment Variables</a></li></ol></li><li class="chapter-item expanded "><a href="22-run-with-docker.html"><strong aria-hidden="true">2.2.</strong> Running with Docker</a></li><li class="chapter-item expanded "><a href="23-run-with-docker-compose.html"><strong aria-hidden="true">2.3.</strong> Running with Docker Compose</a></li><li class="chapter-item expanded "><a href="24-run-with-nginx.html"><strong aria-hidden="true">2.4.</strong> Running with NGINX</a></li><li class="chapter-item expanded "><a href="25-troubleshooting.html"><strong aria-hidden="true">2.5.</strong> Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><a href="30-config-file.html"><strong aria-hidden="true">3.</strong> Configuration File</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="31-pg-connections.html"><strong aria-hidden="true">3.1.</strong> PostgreSQL Connections</a></li><li class="chapter-item expanded "><a href="32-sources-pg-tables.html"><strong aria-hidden="true">3.2.</strong> PostgreSQL Table Sources</a></li><li class="chapter-item expanded "><a href="33-sources-pg-functions.html"><strong aria-hidden="true">3.3.</strong> PostgreSQL Function Sources</a></li><li class="chapter-item expanded "><a href="34-sources-files.html"><strong aria-hidden="true">3.4.</strong> MBTiles and PMTiles File Sources</a></li><li class="chapter-item expanded "><a href="35-sources-composite.html"><strong aria-hidden="true">3.5.</strong> Composite Sources</a></li><li class="chapter-item expanded "><a href="36-sources-sprites.html"><strong aria-hidden="true">3.6.</strong> Sprite Sources</a></li><li class="chapter-item expanded "><a href="37-sources-fonts.html"><strong aria-hidden="true">3.7.</strong> Font Sources</a></li></ol></li><li class="chapter-item expanded "><a href="40-using-endpoints.html"><strong aria-hidden="true">4.</strong> Usage and Endpoint API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="41-using-with-maplibre.html"><strong aria-hidden="true">4.1.</strong> Using with MapLibre</a></li><li class="chapter-item expanded "><a href="42-using-with-leaflet.html"><strong aria-hidden="true">4.2.</strong> Using with Leaflet</a></li><li class="chapter-item expanded "><a href="43-using-with-deck-gl.html"><strong aria-hidden="true">4.3.</strong> Using with deck.gl</a></li><li class="chapter-item expanded "><a href="44-using-with-mapbox.html"><strong aria-hidden="true">4.4.</strong> Using with Mapbox</a></li><li class="chapter-item expanded "><a href="45-recipes.html"><strong aria-hidden="true">4.5.</strong> Recipes</a></li></ol></li><li class="chapter-item expanded "><a href="50-tools.html" class="active"><strong aria-hidden="true">5.</strong> Tools</a></li><li class="chapter-item expanded "><a href="60-development.html"><strong aria-hidden="true">6.</strong> Development</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Martin Tile Server Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/maplibre/martin" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/maplibre/martin/edit/main/docs/src/50-tools.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tools"><a class="header" href="#tools">Tools</a></h1>
<p>Martin has a few additional tools that can be used to interact with the data.</p>
<h2 id="mbtiles-tool"><a class="header" href="#mbtiles-tool">MBTiles tool</a></h2>
<p>A small utility that allows users to interact with the <code>*.mbtiles</code> files from the command line. Use <code>mbtiles --help</code> to see a list of available commands, and <code>mbtiles &lt;command&gt; --help</code> to see help for a specific command.</p>
<p>This tool can be installed by compiling the latest released version with <code>cargo install martin-mbtiles</code>, or by downloading a pre-built binary from the <a href="https://github.com/maplibre/martin/releases/latest">releases page</a>.</p>
<h3 id="meta-all"><a class="header" href="#meta-all">meta-all</a></h3>
<p>Print all metadata values to stdout, as well as the results of tile detection. The format of the values printed is not stable, and should only be used for visual inspection.</p>
<pre><code class="language-shell">mbtiles meta-all my_file.mbtiles
</code></pre>
<h3 id="meta-get"><a class="header" href="#meta-get">meta-get</a></h3>
<p>Retrieve raw metadata value by its name. The value is printed to stdout without any modifications.  For example, to get the <code>description</code> value from an mbtiles file:</p>
<pre><code class="language-shell">mbtiles meta-get my_file.mbtiles description
</code></pre>
<h3 id="meta-set"><a class="header" href="#meta-set">meta-set</a></h3>
<p>Set metadata value by its name, or delete the key if no value is supplied. For example, to set the <code>description</code> value to <code>A vector tile dataset</code>:</p>
<pre><code class="language-shell">mbtiles meta-set my_file.mbtiles description &quot;A vector tile dataset&quot;
</code></pre>
<h3 id="copy"><a class="header" href="#copy">copy</a></h3>
<p>Copy an mbtiles file, optionally filtering its content by zoom levels.</p>
<pre><code class="language-shell">mbtiles copy src_file.mbtiles dst_file.mbtiles \
        --min-zoom 0 --max-zoom 10
</code></pre>
<p>Copy command can also be used to compare two mbtiles files and generate a delta (diff) file. The diff file can be applied to the <code>src_file.mbtiles</code> elsewhere, to avoid copying/transmitting the entire modified dataset.  The delta file will contain all tiles that are different between the two files (modifications, insertions, and deletions as <code>NULL</code> values), for both the tile and metadata tables.</p>
<p>There is one exception: <code>agg_tiles_hash</code> metadata value will be renamed to <code>agg_tiles_hash_in_diff</code>, and a new <code>agg_tiles_hash</code> will be generated for the diff file itself. This is done to avoid confusion when applying the diff file to the original file, as the <code>agg_tiles_hash</code> value will be different after the diff is applied. The <code>apply-diff</code> command will automatically rename the <code>agg_tiles_hash_in_diff</code> value back to <code>agg_tiles_hash</code> when applying the diff.</p>
<pre><code class="language-shell">mbtiles copy src_file.mbtiles diff_file.mbtiles \
         --diff-with-file modified_file.mbtiles
</code></pre>
<p>This command can also be used to generate files of different <a href="##supported-schema">supported schema</a>.</p>
<pre><code class="language-shell">mbtiles copy normalized.mbtiles dst.mbtiles \
         --dst-mbttype flat-with-hash
</code></pre>
<h3 id="apply-diff"><a class="header" href="#apply-diff">apply-diff</a></h3>
<p>Apply the diff file generated from <code>copy</code> command above to an mbtiles file. The diff file can be applied to the <code>src_file.mbtiles</code> elsewhere, to avoid copying/transmitting the entire modified dataset.</p>
<p>Note that the <code>agg_tiles_hash_in_diff</code> metadata value will be renamed to <code>agg_tiles_hash</code> when applying the diff. This is done to avoid confusion when applying the diff file to the original file, as the <code>agg_tiles_hash</code> value will be different after the diff is applied.</p>
<pre><code class="language-shell">mbtiles apply_diff src_file.mbtiles diff_file.mbtiles
</code></pre>
<p>Another way to apply the diff is to use the <code>sqlite3</code> command line tool directly. This SQL will delete all tiles from <code>src_file.mbtiles</code> that are set to <code>NULL</code> in <code>diff_file.mbtiles</code>, and then insert or update all new tiles from <code>diff_file.mbtiles</code> into <code>src_file.mbtiles</code>, where both files are of <code>flat</code> type. The name of the diff file is passed as a query parameter to the sqlite3 command line tool, and then used in the SQL statements.</p>
<pre><code class="language-shell">sqlite3 src_file.mbtiles \
  -bail \
  -cmd &quot;.parameter set @diffDbFilename diff_file.mbtiles&quot; \
  &quot;ATTACH DATABASE @diffDbFilename AS diffDb;&quot; \
  &quot;DELETE FROM tiles WHERE (zoom_level, tile_column, tile_row) IN (SELECT zoom_level, tile_column, tile_row FROM diffDb.tiles WHERE tile_data ISNULL);&quot; \
  &quot;INSERT OR REPLACE INTO tiles (zoom_level, tile_column, tile_row, tile_data) SELECT * FROM diffDb.tiles WHERE tile_data NOTNULL;&quot;
</code></pre>
<h3 id="validate"><a class="header" href="#validate">validate</a></h3>
<p>If the <code>.mbtiles</code> file is of <code>flat_with_hash</code> or <code>normalized</code> type, then verify that the data stored in columns <code>tile_hash</code> and <code>tile_id</code> respectively are MD5 hashes of the <code>tile_data</code> column.</p>
<pre><code class="language-shell">mbtiles validate src_file.mbtiles
</code></pre>
<h2 id="content-validation"><a class="header" href="#content-validation">Content Validation</a></h2>
<p>The original <a href="https://github.com/mapbox/mbtiles-spec#readme">MBTiles specification</a> does not provide any guarantees for the content of the tile data in MBTiles. This tool adds a few additional conventions to ensure that the content of the tile data is valid.</p>
<p>A typical Normalized schema generated by tools like <a href="https://github.com/mapbox/TileLive#bintilelive-copy">tilelive-copy</a> use MD5 hash in the <code>tile_id</code> column. The Martin’s <code>mbtiles</code> tool can use this hash to verify the content of each tile. We also define a new <code>flat-with-hash</code> schema that stores the hash and tile data in the same table. This schema is more efficient than the <code>normalized</code> schema when data has no duplicate tiles (see below). Per tile validation is not available for <code>flat</code> schema.</p>
<p>Per-tile validation will catch individual invalid tiles, but it will not detect overall datastore corruption (e.g. missing tiles or tiles that shouldn’t exist, or tiles with incorrect z/x/y values).
For that, Martin <code>mbtiles</code> tool defines a new metadata value called <code>agg_tiles_hash</code>. The value is computed by hashing <code>cast(zoom_level AS text), cast(tile_column AS text), cast(tile_row AS text), tile_data</code> combined for all rows in the <code>tiles</code> table/view, ordered by z,x,y.
In case there are no rows or all are NULL, the hash value of an empty string is used. Note that SQLite allows any value type to be stored as in any column, so if <code>tile_data</code> accidentally contains non-blob/text/null value, validation will fail.</p>
<p>The <code>mbtiles</code> tool will compute <code>agg_tiles_hash</code> value when copying or validating mbtiles files.</p>
<h2 id="supported-schema"><a class="header" href="#supported-schema">Supported Schema</a></h2>
<p>The <code>mbtiles</code> tool supports three different kinds of schema for <code>tiles</code> data in <code>.mbtiles</code> files. See also the original <a href="https://github.com/mapbox/mbtiles-spec#readme">specification</a>.</p>
<h3 id="flat"><a class="header" href="#flat">flat</a></h3>
<pre><code class="language-sql  ignore">CREATE TABLE tiles (zoom_level integer, tile_column integer, tile_row integer, tile_data blob);
CREATE UNIQUE INDEX tile_index on tiles (zoom_level, tile_column, tile_row);
</code></pre>
<h3 id="flat-with-hash"><a class="header" href="#flat-with-hash">flat-with-hash</a></h3>
<pre><code class="language-sql  ignore">CREATE TABLE tiles_with_hash (
  zoom_level integer NOT NULL,
  tile_column integer NOT NULL,
  tile_row integer NOT NULL,
  tile_data blob,
  tile_hash text);
CREATE UNIQUE INDEX tiles_with_hash_index on tiles_with_hash (zoom_level, tile_column, tile_row);
CREATE VIEW tiles AS SELECT zoom_level, tile_column, tile_row, tile_data FROM tiles_with_hash;
</code></pre>
<h3 id="normalized"><a class="header" href="#normalized">normalized</a></h3>
<pre><code class="language-sql  ignore">CREATE TABLE map (zoom_level INTEGER, tile_column INTEGER, tile_row INTEGER, tile_id TEXT);
CREATE UNIQUE INDEX map_index ON map (zoom_level, tile_column, tile_row);
CREATE TABLE images (tile_id text, tile_data blob);
CREATE UNIQUE INDEX images_id ON images (tile_id);
CREATE VIEW tiles AS
  SELECT
      map.zoom_level AS zoom_level,
      map.tile_column AS tile_column,
      map.tile_row AS tile_row,
      images.tile_data AS tile_data
  FROM map
  JOIN images ON images.tile_id = map.tile_id;
</code></pre>
<p>Optionally, <code>.mbtiles</code> files with <code>normalized</code> schema can include a <code>tiles_with_hash</code> view:</p>
<pre><code class="language-sql  ignore">CREATE VIEW tiles_with_hash AS
  SELECT
      map.zoom_level AS zoom_level,
      map.tile_column AS tile_column,
      map.tile_row AS tile_row,
      images.tile_data AS tile_data,
      images.tile_id AS tile_hash
  FROM map LEFT JOIN images ON map.tile_id = images.tile_id;
</code></pre>
<p><strong><strong>Note:</strong></strong> All <code>normalized</code> files created by the <code>mbtiles</code> tool will contain this view.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="45-recipes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="60-development.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="45-recipes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="60-development.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
